const PSEUDO="pseudo",GROUPE="groupe",BILLET="billet";function init(){let page=window.location.hash,pseudo=localStorage.getItem("pseudo"),urlGroupe=localStorage.getItem(GROUPE);if($("section").hide(),""!=page&&null!=pseudo){switch(page){case"#groupes":groupes();break;case"#groupe":if(null==urlGroupe){location.hash="#groupes";break}groupe(urlGroupe);break;case"#billet":let urlBillet=localStorage.getItem(BILLET);if(null==urlBillet){location.hash="#groupe";break}billet(urlBillet);break;case"#users":if(null==urlGroupe){location.hash="#groupes";break}users(urlGroupe)}$(page).show()}else $("#index").show(),window.location.hash="#index"}function groupes(){let payload="",target="https://192.168.75.13/api/v2/groupes";$.ajax({url:target,type:"GET",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){console.log("SUCCESS : "+target);let groupesResult=[];for(let groupe of data)/^.*\/(.+)$/.test(groupe)&&groupesResult.push({name:RegExp.$1,url:groupe});console.log(groupesResult);let template=$("#groupesTemplate").html(),text=Mustache.render(template,groupesResult);$("#groupesList").html(text)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur GET : "+target),console.log(xhr.responseText)}})}function join(urlGroupe){localStorage.setItem(GROUPE,urlGroupe),location.hash="#groupe"}function getSummaryBillets(urlTabBillets){let billets=[];for(urlbillet of urlTabBillets)$.ajax({url:urlbillet,type:"GET",crossDomain:!0,async:!1,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){/^.*\/(.+)$/.test(urlbillet)&&billets.push({id:RegExp.$1,titre:data.titre,url:urlbillet})},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+urlbillet),console.log(xhr.responseText)}});return billets}function groupe(urlGroupe){$.ajax({url:urlGroupe,type:"GET",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){$("#grpName").html("Groupe "+data.nom),$("#grpDesc").html(data.description);let template=$("#SbilletsTemplate").html(),text=Mustache.render(template,getSummaryBillets(data.billets));$("#bltList").html(text)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+urlGroupe),console.log(xhr.responseText)}})}function displayBtn(idElement){$("#"+idElement).show()}function save_titreB(urlBillet,idBillet){let payload;$.ajax({url:urlBillet,type:"GET",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){payload=data},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}});let editedTitle=$("#titre_"+idBillet).text();if(editedTitle===payload.titre)return void $("#edit_"+idBillet).hide();payload.titre=editedTitle;let target=urlBillet;$.ajax({url:target,type:"PUT",crossDomain:!0,data:payload,xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+target),join(localStorage.getItem(GROUPE))},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}}),$("#edit_"+idBillet).hide()}function openBillet(urlBillet){localStorage.setItem(BILLET,urlBillet),location.hash="#billet"}function deleteBillet(url){$.ajax({url:url,type:"DELETE",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+url),join(localStorage.getItem(GROUPE))},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+url),console.log(xhr.responseText)}})}function billet(urlBillet){$.ajax({url:urlBillet,type:"GET",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){$("#bltAuteur").text(data.auteur),$("#bltTitre").text(data.titre),$("#bltContenu").text(data.contenu);let template=$("#commentairesTemplate").html(),text=Mustache.render(template,commentaires(data.commentaires));$("#commentList").html(text)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}})}function commentaires(urlTab){result=[];for(let url of urlTab)$.ajax({url:url,type:"GET",crossDomain:!0,async:!1,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){/^.*\/(.+)$/.test(url)&&result.push({id:RegExp.$1,texte:data.texte,auteur:data.auteur})},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}});return result}function save_commentaire(urlCom,idCom,author){if(localStorage.getItem(PSEUDO)==author){let newText,comm={auteur:author,text:$("text_"+idCom).text()};$.ajax({url:urlCom,type:"PUT",crossDomain:!0,data:comm,xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+target)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}})}else $(".errMsg").append("Seul l'auteur d'un commentaire peut le modifier.");$("#editC_"+idCom).hide()}function users(urlGroupe){let target="https://192.168.75.13/api/v2/users";$.ajax({url:target,type:"GET",crossDomain:!0,xhrFields:{withCredentials:!0},headers:{Accept:"application/json"},success:function(data){let template=$("#usersTemplate").html(),text=Mustache.render(template,data.membres);$("#usersList").html(text)}})}$((function(){$("#pseudoForm").submit(event=>{event.preventDefault();let target="https://192.168.75.13/api/v2/users/login",psd=$("#pseudo").val();console.log(psd);let requestData=JSON.stringify({pseudo:psd});$.ajax({url:target,type:"POST",xhrFields:{withCredentials:!0},crossDomain:!0,data:requestData,datatype:"json",headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+target)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}}).done((function(data,textstatus,xhr){localStorage.setItem("pseudo",psd),window.location="#groupes"}))}),$("#addgroupeForm").submit(event=>{event.preventDefault();let target="https://192.168.75.13/api/v2/groupes",groupe=$("#groupeInput").val(),requestData=JSON.stringify({nom:groupe});$.ajax({url:target,type:"POST",crossDomain:!0,data:requestData,datatype:"json",xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+target),console.log("groupe : "+groupe),join(target+"/"+groupe)},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}})}),$("#newBilletForm").submit(event=>{event.preventDefault();let target=localStorage.getItem(GROUPE)+"/billets",titre=$("#titreBillet").val(),text=$("#contenuBilletInput").val(),requestData=JSON.stringify({titre:titre,contenu:text,auteur:localStorage.getItem("pseudo"),commentaires:[]});$.ajax({url:target,type:"POST",crossDomain:!0,data:requestData,datatype:"json",xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data,status,xhr){console.log("SUCCESS : "+target),openBillet(xhr.getResponseHeader("Location"))},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}})}),$("#addCommentaireForm").submit(event=>{event.preventDefault();let target=localStorage.getItem(BILLET)+"/commentaires",text=$("#commentaireInput").val(),requestData=JSON.stringify({auteur:localStorage.getItem("pseudo"),texte:text});$.ajax({url:target,type:"POST",crossDomain:!0,data:requestData,datatype:"json",xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json"},success:function(data){console.log("SUCCESS : "+target),openBillet(localStorage.getItem(BILLET))},error:function(xhr,textStatus,errorThrown){$(".errMsg").append("Erreur POST : "+target),console.log(xhr.responseText)}})})})),$((function(){init(),$(window).on("hashchange",init)}));